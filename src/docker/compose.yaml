services:
  etcd:
    image: quay.io/coreos/etcd:v3.6.7
    command:
      - /usr/local/bin/etcd
      - --name=etcd0
      - --data-dir=/etcd-data
      - --listen-client-urls=http://0.0.0.0:2379
      - --advertise-client-urls=http://etcd:2379
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-advertise-peer-urls=http://etcd:2380
      - --initial-cluster=etcd0=http://etcd:2380
      - --initial-cluster-state=new
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
  init:
    build: ./setup_script/
    depends_on:
      etcd:
        condition: service_healthy
  paxos0:
    build: ../server/
    image: paxos-server:dev
    pull_policy: never
    ports:
      - "8080:8080"
    depends_on:
      init:
        condition: service_completed_successfully
    command: --id 0 -v
  paxos1:
    image: paxos-server:dev
    ports:
      - "8081:8081"
    depends_on:
      init:
        condition: service_completed_successfully
    command: --id 1 -v
  paxos2:
    image: paxos-server:dev
    pull_policy: never
    ports:
      - "8082:8082"
    depends_on:
      init:
        condition: service_completed_successfully
    command: --id 2 -v
  paxos3:
    image: paxos-server:dev
    pull_policy: never
    ports:
      - "8083:8083"
    depends_on:
      init:
        condition: service_completed_successfully
    command: --id 3 -v
  paxos4:
    image: paxos-server:dev
    pull_policy: never
    ports:
      - "9004:9004"
      - "8084:8084"
    depends_on:
      init:
        condition: service_completed_successfully
    command: --id 4 -v
